From 2fae3973183ffa7f415c2dc06b80bcd8cf1bea52 Mon Sep 17 00:00:00 2001
From: Zhang Owen <owen.zhang@intel.com>
Date: Wed, 10 Jul 2019 14:42:07 +0800
Subject: [PATCH 4/5] misc patch

Change-Id: I9ac11953e7810d9e637a6e120c376320398c28d3
---
 include/linux/fs.h | 15 +++++++++++++--
 1 file changed, 13 insertions(+), 2 deletions(-)

diff --git a/include/linux/fs.h b/include/linux/fs.h
index b91749b..e459c68 100644
--- a/include/linux/fs.h
+++ b/include/linux/fs.h
@@ -31,6 +31,7 @@
 #include <linux/blk_types.h>
 #include <linux/workqueue.h>
 #include <linux/percpu-rwsem.h>
+#include <linux/major.h>
 
 #include <asm/byteorder.h>
 #include <uapi/linux/fs.h>
@@ -2404,6 +2405,16 @@ static inline void bd_unlink_disk_holder(struct block_device *bdev,
 
 /* fs/char_dev.c */
 #define CHRDEV_MAJOR_HASH_SIZE	255
+
+/*Need to create 512 binder devices*/
+/*Increase misc devices number from 256 to 1024*/
+#define MAJOR_FILTER(x, y, base) ({ \
+  typeof(x) _x = (x); \
+  typeof(y) _y = (y); \
+ (void) (&_x == &_y); \
+  _x == _y ? base * 4 : base; \
+})
+
 extern int alloc_chrdev_region(dev_t *, unsigned, unsigned, const char *);
 extern int register_chrdev_region(dev_t, unsigned, const char *);
 extern int __register_chrdev(unsigned int major, unsigned int baseminor,
@@ -2417,12 +2428,12 @@ extern void chrdev_show(struct seq_file *,off_t);
 static inline int register_chrdev(unsigned int major, const char *name,
 				  const struct file_operations *fops)
 {
-	return __register_chrdev(major, 0, 256, name, fops);
+	return __register_chrdev(major, 0, MAJOR_FILTER(major, (unsigned int)MISC_MAJOR, 256), name, fops);
 }
 
 static inline void unregister_chrdev(unsigned int major, const char *name)
 {
-	__unregister_chrdev(major, 0, 256, name);
+	__unregister_chrdev(major, 0, MAJOR_FILTER(major, (unsigned int)MISC_MAJOR, 256), name);
 }
 
 /* fs/block_dev.c */
-- 
1.8.3.1

